<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>ESP Web Tools</title>
    <meta
      name="description"
      content="Antcontroller flasher test."
    />
    <meta name="viewport" content="width=device-width" />
    <meta name="color-scheme" content="dark light" />
    <style>
      body {
        font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI",
          Roboto, Ubuntu, sans-serif;
        padding: 0;
        margin: 0;
        line-height: 1.4;
      }
      .content {
        max-width: 600px;
        margin: 0 auto;
        padding: 12px;
        display: flex;
        gap: 20px;
        max-width: 1000px;
      }
      .readme-container {
        flex: 2;
        min-width: 250px;
        overflow-y: auto;
        padding-right: 10px;
        border-right: 1px solid #444;
        padding-left: 10px;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }
      .firmware-list-container {
        flex: 1;
        min-width: 200px;
      }
      h2 {
        margin-top: 2em;
      }
      h3 {
        margin-top: 1.5em;
      }
      .projects {
        display: flex;
        text-align: center;
        flex-wrap: wrap;
        gap: 24px;
        justify-content: center;
      }
      .projects a {
        color: initial;
        text-decoration: none;
      }
      .project .logo img {
        height: 50px;
      }
      .project .name {
        margin-top: 8px;
      }
      a {
        color: #03a9f4;
      }
      .screenshot {
        text-align: center;
      }
      .screenshot img {
        max-width: 100%;
        box-shadow: rgb(0 0 0 / 20%) 0px 2px 1px -1px,
          rgb(0 0 0 / 14%) 0px 1px 1px 0px, rgb(0 0 0 / 12%) 0px 1px 3px 0px;
        border-radius: 4px;
      }
      .screenshot i {
        margin-top: 4px;
        display: block;
      }
      .videoWrapper {
        position: relative;
        padding-bottom: 56.25%; /* 16:9 */
        height: 0;
        margin-bottom: 25px;
        background: #ccc;
      }
      .hidden {
        display: none;
      }
      .content pre {
        display: block;
        padding-left: 8px;
        overflow-y: scroll;
      }
      .footer {
        margin-top: 24px;
        border-top: 1px solid #ccc;
        padding-top: 24px;
        text-align: center;
      }
      .footer .initiative {
        font-style: italic;
        margin-top: 16px;
      }
      table {
        border-spacing: 0;
      }
      td {
        padding: 8px;
        border-bottom: 1px solid #ccc;
      }
      .install-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ccc;
        border-radius: 4px;
        background-color: #2e2e2e; /* Slightly lighter dark background */
        box-shadow: rgb(0 0 0 / 20%) 0px 2px 1px -1px, rgb(0 0 0 / 14%) 0px 1px 1px 0px, rgb(0 0 0 / 12%) 0px 1px 3px 0px;
      }
      .install-section h2 {
        margin-top: 0;
        padding-bottom: 10px;
        border-bottom: 1px solid #444; /* Separator for the version title */
        margin-bottom: 15px;
      }
      .install-section .button-container {
        margin: 0 10px 15px 0; /* Add space to the right and bottom */
        padding: 10px;
        border: 1px solid #444;
        border-radius: 4px;
        flex: 1; /* Allow containers to grow and shrink */
        min-width: 150px; /* Ensure a minimum width */
      }
      .install-buttons-wrapper {
        display: flex;
        flex-wrap: wrap; /* Allow buttons to wrap to the next line */
        gap: 10px; /* Space between button containers */
        margin-bottom: -15px; /* Compensate for button-container bottom margin */
      }
      .install-section .button-container div {
         margin-bottom: 8px; /* Space between type label and button */
         font-weight: bold;
      }
      .install-section .timestamp {
         font-size: 0.9em;
         color: #bbb; /* Lighter color for timestamp */
         margin-top: -10px; /* Pull it closer to the title */
         margin-bottom: 15px; /* Space before readme/buttons */
      }
      @media (prefers-color-scheme: dark) {
        body {
          background-color: #333;
          color: #fff;
        }
        a {
          color: #58a6ff;
        }
        .install-section {
          border-color: #666;
        }
      }
      .readme-container h1, .readme-container h2, .readme-container h3, .readme-container h4, .readme-container h5, .readme-container h6 {
          margin-top: 1.5em;
          margin-bottom: 0.5em;
          line-height: 1.2;
      }
      .readme-container h1 {
          border-bottom: 2px solid #444;
          padding-bottom: 0.3em;
      }
      .readme-container h2 {
          border-bottom: 1px solid #444;
          padding-bottom: 0.3em;
      }
      .readme-container p {
          margin-top: 0.8em;
          margin-bottom: 0.8em;
      }
      .readme-container ul, .readme-container ol {
          margin-top: 0.8em;
          margin-bottom: 0.8em;
          padding-left: 20px;
      }
      .readme-container li {
          margin-bottom: 0.4em;
      }
      .readme-container code {
          font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
          background-color: rgba(128, 128, 128, 0.2);
          padding: 0.2em 0.4em;
          border-radius: 3px;
      }
      .readme-container pre {
          background-color: rgba(128, 128, 128, 0.1);
          padding: 1em;
          border-radius: 5px;
          overflow-x: auto;
          margin-top: 1em;
          margin-bottom: 1em;
      }
      .readme-container pre code {
          background-color: transparent;
          padding: 0;
          border-radius: 0;
      }
      .readme-container table {
          border-collapse: collapse;
          margin: 1em 0;
          width: 100%;
      }
      .readme-container th, .readme-container td {
          border: 1px solid #444;
          padding: 0.6em 1em;
          text-align: left;
      }
      .readme-container th {
          background-color: #444;
      }
      .readme-container img {
        max-width: 100%;
        height: auto;
        display: block;
        margin: 1em 0;
      }
    </style>
    <script module>
      import("https://unpkg.com/esp-web-tools/dist/web/install-button.js?module");
    </script>
    <!-- Script to load Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked@4.0.10/marked.min.js"></script>
  </head>
  <body>
    <div class="content">
      <div class="readme-container">
        <div id="readme-content"></div>
      </div>

      <div class="firmware-list-container">
        <h3>Firmware list:</h3>
        <div id="install-buttons">
          <!-- Install buttons will be dynamically inserted here -->
        </div>
      </div>
    </div>    

    <script>
      async function loadReadme() {
        try {
          const response = await fetch('/static/readme.md');
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const readmeText = await response.text();
          const readmeElement = document.getElementById('readme-content');
          // Use Marked.js to convert Markdown to HTML
          readmeElement.innerHTML = marked.parse(readmeText);
        } catch (error) {
          console.error('Error loading readme:', error);
          const readmeElement = document.getElementById('readme-content');
          readmeElement.innerHTML = '<p>Error loading README.md.</p>';
        }
      }

      async function loadManifests() {
        try {
          const response = await fetch('/antctrl/manifests');
          const data = await response.json();
          const container = document.getElementById('install-buttons');
          
          data.available_manifests.forEach(versionGroup => {
            const section = document.createElement('div');
            section.className = 'install-section';
            
            const title = document.createElement('h2');
            title.textContent = `${versionGroup.version}`;
            section.appendChild(title);

            if (versionGroup.latest_mtime > 0) {
              const timestampElement = document.createElement('p');
              const date = new Date(versionGroup.latest_mtime * 1000);
              timestampElement.textContent = `Last updated: ${date.toLocaleString()}`;
              timestampElement.className = 'timestamp';
              section.appendChild(timestampElement);
            }

            if (versionGroup.readme) {
              const readmeElement = document.createElement('div');
              readmeElement.innerHTML = `<pre>${versionGroup.readme}</pre>`;
              readmeElement.style.marginBottom = '20px';
              section.appendChild(readmeElement);
            }

            const buttonsWrapper = document.createElement('div');
            buttonsWrapper.className = 'install-buttons-wrapper';
            section.appendChild(buttonsWrapper);

            versionGroup.manifests.forEach(manifest => {
              const buttonContainer = document.createElement('div');
              buttonContainer.className = 'button-container';
              
              const typeLabel = document.createElement('div');
              typeLabel.textContent = manifest.type.charAt(0).toUpperCase() + manifest.type.slice(1);
              typeLabel.style.marginBottom = '5px';
              buttonContainer.appendChild(typeLabel);

              const button = document.createElement('esp-web-install-button');
              button.setAttribute('manifest', manifest.url);
              button.innerHTML = `
                <i slot="unsupported">
                  The demo is not available because your browser does not support Web
                  Serial. Open this page in Google Chrome or Microsoft Edge instead.
                </i>
              `;
              buttonContainer.appendChild(button);
              
              buttonsWrapper.appendChild(buttonContainer);
            });

            container.appendChild(section);
          });
        } catch (error) {
          console.error('Error loading manifests:', error);
          const container = document.getElementById('install-buttons');
          container.innerHTML = '<p>Error loading firmware manifests. Please try again later.</p>';
        }
      }

      document.addEventListener('DOMContentLoaded', loadManifests);
      document.addEventListener('DOMContentLoaded', loadReadme);
    </script>
  </body>
</html>
